{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}{{ prop.titulo }} | KCM{% endblock %}
{% block content %}

<!-- =======================
     Flash messages
======================= -->
{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<!-- =======================
     Encabezado de la propiedad
======================= -->
<h1 class="h3 mb-2">{{ prop.get_tipo_propiedad_display }} {{ prop.comuna }}</h1>
<p class="text-muted mb-3">
  {{ prop.get_tipo_propiedad_display }} • {{ prop.get_tipo_operacion_display }} • {{ prop.region }}
</p>

<!-- =======================
     FILA PRINCIPAL
     IZQ: Galería
     DER: Ficha con precio + features + CTA
======================= -->
<div class="row g-4 align-items-start">

  <!-- --- IZQUIERDA: GALERÍA --- -->
  <div class="col-lg-7">
    <div id="galeriaProp" class="carousel slide mb-3" data-bs-ride="false">
      <div class="carousel-inner aspect-ratio-16x9 rounded-3 overflow-hidden">
        <!-- Portada como primer slide (activa) si existe -->
        {% if prop.portada %}
          <div class="carousel-item active">
            <img src="{{ prop.portada.url }}" class="carousel-img d-block w-100" alt="Portada">
          </div>
        {% endif %}

        <!-- Resto de imágenes -->
        {% for img in prop.imagenes.all %}
          <div class="carousel-item {% if not prop.portada and forloop.first %}active{% endif %}">
            <img src="{{ img.imagen.url }}" class="carousel-img d-block w-100" alt="Foto {{ forloop.counter }}">
          </div>
        {% endfor %}
      </div>

      <!-- Controles del carrusel -->
      <button class="carousel-control-prev" type="button" data-bs-target="#galeriaProp" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Anterior</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#galeriaProp" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Siguiente</span>
      </button>
    </div>

    <!-- Thumbnails con flechas laterales -->
    <div class="thumbs-wrapper position-relative mb-3">
      <button class="thumbs-btn thumbs-prev btn btn-light btn-sm" type="button" aria-label="Anterior">
        <i class="bi bi-chevron-left"></i>
      </button>

      <div class="thumbs-strip d-flex gap-2 overflow-auto flex-nowrap" id="thumbsStrip">
        <!-- Miniatura de portada (si existe) -->
        {% if prop.portada %}
          <button type="button"
                  data-bs-target="#galeriaProp"
                  data-bs-slide-to="0"
                  class="thumb-indicator active"
                  aria-current="true"
                  aria-label="Portada">
            <img src="{{ prop.portada.url }}" class="thumb-img" alt="Miniatura portada">
          </button>
        {% endif %}

        <!-- Miniaturas del resto -->
        {% for img in prop.imagenes.all %}
          {% if prop.portada %}
            {% with forloop.counter as idx %}
              <button type="button"
                      data-bs-target="#galeriaProp"
                      data-bs-slide-to="{{ idx }}"
                      class="thumb-indicator"
                      aria-label="Foto {{ idx }}">
                <img src="{{ img.imagen.url }}" class="thumb-img" alt="Miniatura {{ idx }}">
              </button>
            {% endwith %}
          {% else %}
            {% with forloop.counter0 as idx %}
              <button type="button"
                      data-bs-target="#galeriaProp"
                      data-bs-slide-to="{{ idx }}"
                      class="thumb-indicator {% if forloop.first %}active{% endif %}"
                      {% if forloop.first %}aria-current="true"{% endif %}
                      aria-label="Foto {{ forloop.counter }}">
                <img src="{{ img.imagen.url }}" class="thumb-img" alt="Miniatura {{ forloop.counter }}">
              </button>
            {% endwith %}
          {% endif %}
        {% endfor %}
      </div>

      <button class="thumbs-btn thumbs-next btn btn-light btn-sm" type="button" aria-label="Siguiente">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- --- DERECHA: FICHA --- -->
  <div class="col-lg-5">
    <div class="p-4 bg-body-tertiary border mb-3">
      <!-- Precio principal en CLP; JS rellena equivalencia UF -->
      <div class="d-flex align-items-baseline justify-content-between mb-3">
        <h2 class="h3 fw-bold mb-0">
          {% if prop.precio_clp %}
            <span class="d-inline-flex align-items-baseline" data-price-clp="{{ prop.precio_clp }}" {% if prop.precio_uf %}data-price-uf="{{ prop.precio_uf }}"{% endif %} data-show-uf>
              <span data-clp-out>$ {{ prop.precio_clp|intcomma }}</span>
              <small class="ms-3 text-muted small fs-5{% if not prop.precio_uf %} d-none{% endif %}" data-uf-wrapper>
                (<span data-uf-out>{% if prop.precio_uf %}{{ prop.precio_uf|floatformat:"-2" }}{% endif %}</span> UF)
              </small>
            </span>
          {% elif prop.precio_uf %}
            <span class="d-inline-flex align-items-baseline" data-price-uf="{{ prop.precio_uf }}" data-show-uf>
              <span data-clp-out>UF {{ prop.precio_uf|floatformat:"-2" }}</span>
              <small class="ms-2 text-muted" data-uf-wrapper>
                (<span data-uf-out>{{ prop.precio_uf|floatformat:"-2" }}</span> UF)
              </small>
            </span>
          {% else %}
            <span class="fs-5 text-muted">Precio a consultar</span>
          {% endif %}
        </h2>
      </div>

      <h4 class="h6 text-uppercase text-muted mb-2">Características</h4>
      <ul class="list-unstyled mb-0">
        <li class="mb-1">
          <i class="bi bi-house-door me-2 text-secondary"></i>
          {{ prop.dormitorios }} dormitorio{{ prop.dormitorios|pluralize }}
        </li>
        <li class="mb-1">
          <i class="bi bi-droplet me-2 text-secondary"></i>
          {{ prop.banos }} baño{{ prop.banos|pluralize }}
        </li>
        <li class="mb-1">
          <i class="bi bi-car-front me-2 text-secondary"></i>
          {{ prop.estacionamientos }} estacionamiento{{ prop.estacionamientos|pluralize }}
        </li>

        <!-- Superficies -->
        {% if prop.sup_construida_m2 and prop.sup_terreno_m2 %}
          <li class="mb-1">
            <i class="bi bi-rulers me-2 text-secondary"></i>
            {{ prop.sup_construida_m2|floatformat:"-2" }}/{{ prop.sup_terreno_m2|floatformat:"-2" }} m²
          </li>
        {% elif prop.sup_construida_m2 %}
          <li class="mb-1">
            <i class="bi bi-rulers me-2 text-secondary"></i>
            {{ prop.sup_construida_m2|floatformat:"-2" }} m² construidos
          </li>
        {% elif prop.sup_terreno_m2 %}
          <li class="mb-1">
            <i class="bi bi-rulers me-2 text-secondary"></i>
            {{ prop.sup_terreno_m2|floatformat:"-2" }} m² terreno
          </li>
        {% endif %}

        <!-- Año construcción -->
        {% if prop.ano_construccion %}
          <li class="mb-1">
            <i class="bi bi-building me-2 text-secondary"></i>
            Año construcción: {{ prop.ano_construccion }}
          </li>
        {% endif %}

        <!-- Dirección -->
        {% if prop.direccion %}
          <li class="mb-1">
            <i class="bi bi-geo-alt me-2 text-secondary"></i>
            {{ prop.direccion }}
          </li>
        {% endif %}
      </ul>

      <!-- CTA que abre el modal -->
      <div class="mt-4 d-grid d-lg-flex">
        <button class="btn btn-dark py-3 fw-semibold"
                data-bs-toggle="modal" data-bs-target="#contactoModal">
          Agendar visita
        </button>
      </div>
    </div>
  </div>
</div>

<!-- =======================
     DESCRIPCIÓN + MAPA (fila inferior)
     IZQ: Descripción  ·  DER: Ubicación
======================= -->
<section class="mt-4">
  <div class="row g-4 align-items-start">

    <!-- IZQUIERDA: DESCRIPCIÓN -->
    <div class="col-lg-7">
      <h4 class="mb-1">
        <i class="bi bi-file-earmark-text me-1"></i> Descripción
      </h4>
      <article class="mt-3 fs-5 fw-light text-justify" lang="es">
        {{ prop.descripcion|linebreaks }}
      </article>
    </div>

    <!-- DERECHA: UBICACIÓN (MAPA) -->
    <div class="col-lg-5">
      <h4 class="mb-3 mt-1 d-flex align-items-center">
        <i class="bi bi-geo-alt-fill text-danger me-2"></i> Ubicación
      </h4>

      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
          {% if prop.direccion or prop.comuna or prop.region %}
            <!-- Iframe de Google Maps sin API key -->
            <iframe
              class="map-embed"
              src="https://www.google.com/maps?q={{ prop.direccion|default_if_none:''|urlencode }}%20{{ prop.comuna|default_if_none:''|urlencode }}%20{{ prop.region|default_if_none:''|urlencode }}&output=embed"
              style="border:0;"
              allowfullscreen
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              title="Mapa de ubicación">
            </iframe>
          {% else %}
            <div class="p-4 text-center">
              <i class="bi bi-geo-alt text-secondary fs-2 mb-2 d-block"></i>
              <p class="fw-semibold mb-1">Ubicación no disponible</p>
              <p class="text-muted mb-0">Aún no se ha registrado la dirección de esta propiedad.</p>
            </div>
          {% endif %}
        </div>

        <!-- Footer con dirección textual -->
        {% if prop.direccion %}
          <div class="card-footer bg-light text-center py-3">
            <p class="fw-semibold mb-0">
              <i class="bi bi-house-door text-primary me-2"></i>
              {{ prop.direccion }}, {{ prop.comuna }}, {{ prop.region }}
            </p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- =======================
     Modal Bootstrap con LeadForm
======================= -->
<div class="modal fade" id="contactoModal" tabindex="-1" aria-labelledby="contactoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-lg border-0">
      <form method="post" novalidate>
        {% csrf_token %}

        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body pt-0 px-4">
          <div class="text-center mb-4">
            <h5 class="fw-bold fs-4 mb-1" id="contactoModalLabel">
              Agendar visita a {{ prop.get_tipo_propiedad_display }} {{ prop.comuna }}
            </h5>
            <p class="text-muted fs-5 mb-0">
              Déjanos tus datos y coordinamos horarios para visitar la propiedad.
            </p>
          </div>

          <!-- Errores generales del form -->
          {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="{{ form.nombre.id_for_label }}">Nombre</label>
              {{ form.nombre }}
              {% for e in form.nombre.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              <div class="form-text">Cómo debemos llamarte.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="{{ form.telefono.id_for_label }}">Teléfono</label>
              {{ form.telefono }}
              {% for e in form.telefono.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              <div class="form-text">Con código de país si es extranjero.</div>
            </div>

            <div class="col-12">
              <label class="form-label" for="{{ form.email.id_for_label }}">Email</label>
              {{ form.email }}
              {% for e in form.email.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              <div class="form-text">Te confirmaremos por correo la visita.</div>
            </div>

            <div class="col-12">
              <label class="form-label" for="{{ form.mensaje.id_for_label }}">Mensaje</label>
              {{ form.mensaje }}
              {% for e in form.mensaje.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              <div class="form-text">Ej: “Disponible sábado en la mañana, ¿tienen horario?”</div>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0 pt-0 px-4">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =======================
     Reabrir modal si hay errores
======================= -->
{% if form.errors %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var contactoModal = new bootstrap.Modal(document.getElementById('contactoModal'));
    contactoModal.show();
  });
</script>
{% endif %}

<!-- =======================
     JS: sincronizar thumbs con el carrusel
======================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const galeria = document.getElementById('galeriaProp');
  if (!galeria) return;

  galeria.addEventListener('slide.bs.carousel', (ev) => {
    const to = ev.to;
    document.querySelectorAll('[data-bs-target="#galeriaProp"][data-bs-slide-to]')
      .forEach(btn => btn.classList.remove('active'));
    const next = document.querySelector(
      `[data-bs-target="#galeriaProp"][data-bs-slide-to="${to}"]`
    );
    if (next) next.classList.add('active');
  });
});
</script>

<!-- =======================
     JS: scroll horizontal de thumbs
======================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const galeria  = document.getElementById('galeriaProp');
  const strip    = document.getElementById('thumbsStrip');
  const prevBtn  = document.querySelector('.thumbs-prev');
  const nextBtn  = document.querySelector('.thumbs-next');
  const scrollStep = 200;

  if (galeria && strip) {
    galeria.addEventListener('slide.bs.carousel', ev => {
      const to = ev.to;
      document.querySelectorAll('[data-bs-target="#galeriaProp"][data-bs-slide-to]')
        .forEach(btn => btn.classList.remove('active'));
      const next = document.querySelector(
        `[data-bs-target="#galeriaProp"][data-bs-slide-to="${to}"]`
      );
      if (next) {
        next.classList.add('active');
        strip.scrollTo({ left: next.offsetLeft - 48, behavior: 'smooth' });
      }
    });
  }

  prevBtn?.addEventListener('click', () => strip?.scrollBy({ left: -scrollStep, behavior: 'smooth' }));
  nextBtn?.addEventListener('click', () => strip?.scrollBy({ left:  scrollStep, behavior: 'smooth' }));
});
</script>

{% endblock %}
